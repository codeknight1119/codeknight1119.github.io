<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DRIFT</title>
</head>

<body>
    <h1>DRIFT</h1>
    <h3>v1.5<h3>
            <button id="pairBttn">Pair</button>
            <p id="out">out</p>
</body>
<script>
    const out = document.getElementById("out")
    document.getElementById("pairBttn").addEventListener("click", async () => {


        navigator.bluetooth.getAvailability().then((available) => {
            if (available) {
            
                                let options = {
                                    filters: [
                                        //  { services: ["heart_rate"] },
                                        //  { services: [0x1802, 0x1803] },
                                         // { services: ["12345"] },
                                     //     { name: "raspberrypi" },
                                          { name: "DRIFT-P"},
                                        // { namePrefix: "Prefix" },
                                       
                                    ],
                                    optionalServices: ["12345678-1234-5678-1234-5678abcdef00"]
                                    // optionalServices: ["battery_service"],
                                };
             /*   let options = {
                    acceptAllDevices: true,
                    optionalServices: ["12345678-1234-5678-1234-5678abcdef00"]
                };*/

               navigator.bluetooth.requestDevice(options)
    .then((device) => {
        out.innerText = "Connecting to GATT Server...";
        console.log("Device Name:", device.name);
        return device.gatt.connect(); // Connect to the server
    })
    .then((server) => {
        out.innerText = "Getting Service...";
        // Ask for the specific Service UUID defined in your Python script
        return server.getPrimaryService("12345678-1234-5678-1234-5678abcdef00");
    })
    .then((service) => {
        out.innerText = "Getting Characteristic...";
        // Ask for the specific Characteristic UUID defined in your Python script
        return service.getCharacteristic("12345678-1234-5678-1234-5678abcdef01");
    })
    .then((characteristic) => {
        out.innerText = "Reading Value...";
        // Trigger the ReadValue method on your Raspberry Pi
        return characteristic.readValue();
    })
    .then((value) => {
        // The Pi sends raw bytes. We use TextDecoder to turn them back into a string.
        const decoder = new TextDecoder('utf-8');
        const text = decoder.decode(value);
        
        // Display the result on the webpage!
        out.innerText = `Success! The Pi says: "${text}"`;
        console.log("Data received:", text);
    })
    .catch((error) => { 
        out.innerText = "Error (Check Console)";
        console.error("Connection failed:", error); 
    });



            } else {
                out.innerText = "Bluetooth denied"
                return
            }
        });
        /*
        
                try {
                    console.log('Requesting Bluetooth Device...');
                    const device = await navigator.bluetooth.requestDevice({
                        // Filter by name or alias
                        filters: [{ name: 'raspberrypi' }],
                        // Or use acceptAllDevices: true if you don't have a specific UUID
                        optionalServices: ['battery_service'] // Required to access services later
                    });
        
                    console.log('Device Name:', device.name);
                    const server = await device.gatt.connect();
                    console.log('Connected to GATT Server');
        
                } catch (error) {
                    console.error('Connection failed!', error);
                }
        
        */
    })

</script>

</html>