<!DOCTYPE html>
<html>

<head>
  <title>Firebase Chatroom</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 20px;
      display: flex;
    }

    #messages {
      border: 1px solid #ccc;
      padding: 10px;
      height: 300px;
      overflow-y: auto;
      position: fixed;
      top: 50px;
      width: 75%;
      display: flex;
      flex-direction: column;
    }

    /* Your messages (right side, blue) */
    .messageMine {
      align-self: flex-end;
      background-color: #e0f0ff;
      border: 1px solid #002aff;
      border-radius: 8px;
      padding: 5px 10px;
      margin-bottom: 8px;
      max-width: 60%;
    }

    /* Other messages (left side, gray) */
    .messageOther {
      align-self: flex-start;
      background-color: #f0f0f0;
      border: 1px solid #aaa;
      border-radius: 8px;
      padding: 5px 10px;
      margin-bottom: 8px;
      max-width: 60%;
    }

    .chatsSelect {
      /* initial width, but can expand/contract */
      width: 200px;
      /* for example */
      min-width: 100px;
      max-width: 400px;
      background-color: #ddd;
      transition: width 0.3s ease;
      /* overflow hidden if you hide content when shrinking */
    }

    #messages {
      flex: 1;
      /* take remaining space */
      background-color: #fafafa;
      padding: 20px;
    }

    .container {
      display: flex;
      height: 100%;
    }
  </style>
</head>

<body>
  <h2>Chatroom</h2>
  <h3>V.1.7</h3>

  <div class="container">
    <div class="chatsSelect"></div>
    <div id="messages"></div>
  </div>

  <div id="messageSend" style="margin-top: 370px;">
    <input type="text" id="name" placeholder="Your name"><br><br>
    <input type="text" id="messageInput" placeholder="Type a message">
    <button id="sendBtn">Send</button>
    <button id="logoutBtn">Logout</button>
    <button id="newConv">Create new conversation</button>
  </div>


<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";
import { getDoc, getDocs, getFirestore, collection, addDoc, query, orderBy, onSnapshot, doc, where } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBuOdufK2UCl9m6iZa35SUQSRF-9HZHcD8",
  authDomain: "chatroom4friends-522bd.firebaseapp.com",
  projectId: "chatroom4friends-522bd",
  storageBucket: "chatroom4friends-522bd.firebasestorage.app",
  messagingSenderId: "26805339142",
  appId: "1:26805339142:web:86ff21490be804a16eaf87",
  measurementId: "G-EXFX8QFGGF"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let myName = "";
let currentChat = null;
let chatUnsubscribe = null;

const chatsSelectDiv = document.querySelector(".chatsSelect");
const messagesDiv = document.getElementById("messages");

document.getElementById("messageSend").style.display = "none";
document.getElementById("messages").style.display = "none";

// --- Helper to get username from UID ---
async function getUsername(uid) {
  const docSnap = await getDoc(doc(db, "users", uid));
  if (docSnap.exists()) return docSnap.data().username;
  return "Unknown";
}

// --- Load all conversations for current user ---
async function loadConversations() {
  chatsSelectDiv.innerHTML = ""; // clear old buttons
  const convSnap = await getDocs(collection(db, "conversations"));

  convSnap.forEach(async (docSnap) => {
    const convId = docSnap.id;
    if (convId.includes(auth.currentUser.uid)) {
      const otherUID = convId.split("_").find(id => id !== auth.currentUser.uid);
      const otherName = await getUsername(otherUID);
      createChatButton(convId, otherName);
    }
  });
}

// --- Create a button for a conversation ---
function createChatButton(convId, otherName) {
  const btn = document.createElement("button");
  btn.textContent = `Chat with ${otherName}`;
  btn.style.display = "block";
  btn.style.marginBottom = "5px";
  btn.onclick = () => openConversation(convId);
  chatsSelectDiv.appendChild(btn);
}

// --- Open a conversation and listen to messages ---
function openConversation(convId) {
  if (chatUnsubscribe) chatUnsubscribe();

  currentChat = convId;
  messagesDiv.innerHTML = "";

  const q = query(collection(db, "conversations", convId), orderBy("timestamp"));
  chatUnsubscribe = onSnapshot(q, (snapshot) => {
    messagesDiv.innerHTML = "";
    snapshot.forEach((doc) => {
      const msg = doc.data();
      const div = document.createElement("div");
      if (msg.name === myName) {
        div.textContent = `You: ${msg.text}`;
        div.className = "messageMine";
      } else {
        div.textContent = `${msg.name}: ${msg.text}`;
        div.className = "messageOther";
      }
      messagesDiv.appendChild(div);
    });
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  });
}

// --- Send a message ---
document.getElementById("sendBtn").onclick = async () => {
  const text = document.getElementById("messageInput").value;
  if (!text.trim()) return;
  if (!currentChat) {
    alert("Select a conversation first!");
    return;
  }
  await addDoc(collection(db, "conversations", currentChat), {
    name: myName,
    text,
    timestamp: Date.now()
  });
  document.getElementById("messageInput").value = "";
};

// --- Logout ---
document.getElementById("logoutBtn").addEventListener("click", () => {
  signOut(auth).then(() => alert("User signed out"));
});

// --- New conversation ---
document.getElementById("newConv").onclick = async () => {
  const talkto = prompt("New chat with who?");
  const firstMessage = prompt("Send a message to be the first message in the chat.");
  if (!talkto || !firstMessage) return;

  const q = query(collection(db, "users"), where("username", "==", talkto));
  const querySnapshot = await getDocs(q);

  if (querySnapshot.empty) return alert("Username does not exist");
  if (querySnapshot.size > 1) return alert("More than 1 user found");

  const talktoUID = querySnapshot.docs[0].id;
  const newChatName = [auth.currentUser.uid, talktoUID].sort().join("_");

  try {
    await addDoc(collection(db, "conversations", newChatName), {
      name: myName,
      text: firstMessage,
      timestamp: Date.now()
    });
    await loadConversations(); // refresh buttons
    openConversation(newChatName); // automatically open new chat
  } catch (err) {
    alert("Error creating conversation: " + err);
  }
};

// --- On login ---
onAuthStateChanged(auth, async (user) => {
  if (user) {
    document.getElementById("messageSend").style.display = "block";
    document.getElementById("messages").style.display = "block";

    myName = await getUsername(user.uid) || "Anonymous";
    document.getElementById("name").value = myName;

    await loadConversations(); // load chat buttons
  } else {
    document.getElementById("messageSend").style.display = "none";
    document.getElementById("messages").style.display = "none";
    if (chatUnsubscribe) chatUnsubscribe();
  }
});
</script>

</body>

</html>