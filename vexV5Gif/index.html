<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>VEX Robotics Image Converter (Optimized)</title>

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@300;400;700&display=swap"
      rel="stylesheet"
    />

    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css"
    />

    <link
      href="https://cdn.jsdelivr.net/npm/daisyui@4.12.10/dist/full.min.css"
      rel="stylesheet"
      type="text/css"
    />
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
      body {
        font-family: 'IBM Plex Sans', sans-serif;
      }
      [data-theme='light'] .code-block {
        scrollbar-color: #e5e7eb transparent;
        scrollbar-width: thin;
      }
      [data-theme='dark'] .code-block {
        scrollbar-color: #1b1f25 transparent;
        scrollbar-width: thin;
      }
      pre { margin: 0; }
    </style>
  </head>
  <body>
    <div id="app"></div>

    <script type="module">
      import { createApp, ref, watch, onMounted, computed } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.js'
      import { Sun, Moon, Download, Clipboard, ClipboardCheck, Github } from 'https://esm.sh/lucide-vue-next'
      import hljs from 'https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/es/highlight.min.js'
      import cpp from 'https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/es/languages/cpp.min.js'

      hljs.registerLanguage('cpp', cpp);

      const App = {
        components: { Sun, Moon, Download, Clipboard, ClipboardCheck, Github },
        setup() {
          // ========== Theme Management ==========
          const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches
          const isDarkTheme = ref(prefersDark)

          if (window.matchMedia) {
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (event) => {
              isDarkTheme.value = event.matches
            })
          }

          onMounted(() => {
            watch(
              isDarkTheme,
              (newValue) => {
                document.documentElement.setAttribute('data-theme', newValue ? 'dark' : 'light')
              },
              { immediate: true }
            )
          })

          // ========== Code Generation ==========
          const uploadedImage = ref(null)
          const generatedCode = ref('')
          const highlightedPreview = ref('') // Store only a preview for UI
          const modalTitle = ref('')
          const modalContent = ref('')
          const recentlyCopied = ref(false)
          const isProcessing = ref(false)

          const debugStats = ref({
            hasData: false,
            uniqueColors: 0,
            totalBlocks: 0,
            uniqueCounts: 0
          })

          function handleFileUpload(event) {
            const file = event.target.files[0]
            if (file) {
              const img = new Image()
              img.onload = function () {
                if (img.width === 480 && img.height === 240) {
                  uploadedImage.value = img
                  processImage()
                } else {
                  modalTitle.value = 'Invalid Image Size'
                  modalContent.value = `Image must be PNG format and have a size of 480×240 pixels. Your image is ${img.width}×${img.height} pixels.`
                  document.getElementById('my_modal_1').showModal()
                  event.target.value = ''
                }
              }
              img.src = URL.createObjectURL(file)
            }
          }

          async function processImage() {
            isProcessing.value = true;
            // Use setTimeout to allow UI to update to "Processing" state before heavy lifting
            setTimeout(() => {
                const canvas = document.createElement('canvas')
                canvas.width = uploadedImage.value.width
                canvas.height = uploadedImage.value.height
                const ctx = canvas.getContext('2d')
                ctx.drawImage(uploadedImage.value, 0, 0)
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height).data

                const encodedImage = encodeImage(imageData, canvas.width, canvas.height)
                generatedCode.value = generateCpp(encodedImage)
                isProcessing.value = false;
            }, 50);
          }

          function encodeImage(imageData, width, height) {
            let encodedImage = []
            let currentColor = null
            let repeatCount = 0

            // Optimized loop
            for (let y = 0; y < height; y++) {
              for (let x = 0; x < width; x++) {
                const index = (y * width + x) * 4
                const a = imageData[index + 3]
                
                let color = ''
                if (a !== 0) {
                  // Pre-calc hex strings for speed
                  const r = imageData[index].toString(16).padStart(2, '0')
                  const g = imageData[index + 1].toString(16).padStart(2, '0')
                  const b = imageData[index + 2].toString(16).padStart(2, '0')
                  color = `#${r}${g}${b}`
                }

                if (color === currentColor) {
                  repeatCount++
                } else {
                  if (currentColor !== null) {
                    encodedImage.push([currentColor, repeatCount])
                  }
                  currentColor = color
                  repeatCount = 1
                }
              }
            }
            encodedImage.push([currentColor, repeatCount])
            return encodedImage
          }

          function generateCpp(encodedImage) {
            // OPTIMIZATION 1: Use Maps/Sets for O(1) lookups instead of .includes() loop
            const uniqueColors = [...new Set(encodedImage.map((item) => item[0]).filter((color) => color !== ''))]
            const colorIndices = new Map(uniqueColors.map((color, index) => [color, index]))
            
            // OPTIMIZATION 2: Use Array.join() instead of string concatenation +=
            // This prevents memory thrashing and huge GC pauses
            const buffer = []

            buffer.push('#include "vex.h"\n\nusing namespace vex;\n\nvoid drawLogo() {\n')
            
            // 1. Colors Array
            buffer.push('    static const char* imageColors[] = {\n        ')
            // Map colors to quoted strings
            buffer.push(uniqueColors.map(c => `"${c}"`).join(', '))
            buffer.push('\n    };\n\n')

            // 2. Indices Array
            buffer.push('    static const int imageIndices[] = {\n        ')
            // Map encoded image to indices efficiently
            const indices = encodedImage.map(item => item[0] === '' ? -1 : colorIndices.get(item[0]))
            buffer.push(indices.join(', '))
            buffer.push('\n    };\n\n')

            // 3. Counts Array
            buffer.push('    static const int imageCounts[] = {\n        ')
            const counts = encodedImage.map(item => item[1])
            buffer.push(counts.join(', '))
            buffer.push('\n    };\n')

            // 4. Logic Boilerplate
            buffer.push(`
    int x = 0, y = 0;
    // Calculate size dynamically
    int totalOps = sizeof(imageIndices) / sizeof(imageIndices[0]);
    
    for(int i = 0; i < totalOps; ++i) {
        int index = imageIndices[i];
        int count = imageCounts[i];
        if(index >= 0) {
            const char* color = imageColors[index];
            Brain.Screen.setPenColor(color);
            for(int j = 0; j < count; ++j) {
                Brain.Screen.drawPixel(x++, y);
                if(x >= 480) { x = 0; y++; }
            }
        } else {
            x += count;
            while(x >= 480) { x -= 480; y++; }
        }
    }
}
`)
            
            // Calculate Debug stats efficiently using Sets
            const uniqueCountsSet = new Set(counts);
            debugStats.value = {
                hasData: true,
                uniqueColors: uniqueColors.length,
                totalBlocks: indices.length,
                uniqueCounts: uniqueCountsSet.size
            }

            return buffer.join('')
          }

          function downloadCode() {
            const blob = new Blob([generatedCode.value], { type: 'text/plain' })
            const link = document.createElement('a')
            link.href = URL.createObjectURL(blob)
            link.download = 'imageCode.cpp'
            link.click()
          }

          const copyCode = () => {
            navigator.clipboard.writeText(generatedCode.value)
            recentlyCopied.value = true
            setTimeout(() => {
              recentlyCopied.value = false
            }, 1500)
          }

          // OPTIMIZATION 3: Only highlight a preview of the code
          // Highlighting 5MB of C++ code crashes the browser. We show the first 2000 chars.
          watch(generatedCode, (newValue) => {
            if (newValue) {
              const previewLimit = 2000;
              const isTruncated = newValue.length > previewLimit;
              const snippet = newValue.substring(0, previewLimit) + (isTruncated ? '\n\n// ... Code truncated for preview. Download to see full file ...' : '');
              highlightedPreview.value = hljs.highlight(snippet, { language: 'cpp' }).value
            }
          })

          return {
            isDarkTheme,
            modalTitle,
            modalContent,
            handleFileUpload,
            copyCode,
            downloadCode,
            generatedCode,
            recentlyCopied,
            highlightedPreview,
            debugStats,
            isProcessing
          }
        },
        template: `
          <dialog id="my_modal_1" class="modal">
            <div class="modal-box">
              <h3 class="font-bold text-lg">{{ modalTitle }}</h3>
              <p class="py-4">{{ modalContent }}</p>
              <div class="modal-action">
                <form method="dialog">
                  <button class="btn">Close</button>
                </form>
              </div>
            </div>
          </dialog>

          <nav class="navbar px-6 border-b border-base-200">
             <div class="flex-1 font-bold text-xl">
               VEX Converter
            </div>

            <div class="flex-1 flex justify-end space-x-2">
              <button
                class="btn btn-sm btn-ghost"
                onclick="window.open('https://github.com/SuhJae/vex-image')"
              >
                <Github :size="20" />
              </button>

              <label class="cursor-pointer grid place-items-center">
                <input
                  type="checkbox"
                  v-model="isDarkTheme"
                  class="toggle bg-base-content row-start-1 col-start-1 col-span-2"
                />
                <Sun :size="14" color="currentColor" class="col-start-1 row-start-1" />
                <Moon :size="14" class="col-start-2 row-start-1" />
              </label>
            </div>
          </nav>

          <section class="h-[25vh] px-8 flex justify-center items-center flex-col">
              <h1 class="font-bold text-center text-3xl sm:text-4xl mb-2">VEX Robotics Image Converter</h1>
              <p class="font-light text-center text-lg opacity-80">
                Optimized high-performance PNG to C++ converter
              </p>
          </section>

          <section class="flex justify-center items-center p-4">
            <div class="p-3 md:p-6 bg-base-100 rounded-lg border border-base-300 max-w-4xl w-full shadow-sm">
              <h2 class="font-bold text-2xl mb-4">Upload Image</h2>
              
              <div class="flex flex-col md:flex-row gap-4 justify-between items-start md:items-center">
                <input
                  type="file"
                  class="file-input w-full max-w-xs file-input-bordered file-input-primary"
                  @change="handleFileUpload"
                  accept="image/png"
                />

                <div class="flex space-x-2">
                  <button
                    class="btn btn-primary"
                    @click="copyCode"
                    :disabled="!generatedCode"
                  >
                    <Clipboard :size="20" v-if="!recentlyCopied" />
                    <ClipboardCheck :size="20" v-else />
                    Copy
                  </button>

                  <button
                    class="btn btn-secondary"
                    @click="downloadCode"
                    :disabled="!generatedCode"
                  >
                    <Download :size="20" />
                    Download
                  </button>
                </div>
              </div>

              <div v-if="isProcessing" class="mt-4 flex items-center justify-center p-4 text-warning">
                <span class="loading loading-spinner loading-md mr-2"></span> Processing heavy image data...
              </div>

              <div v-if="debugStats.hasData && !isProcessing" class="mt-6 grid grid-cols-3 gap-4 text-center">
                <div class="stat bg-base-200 rounded-lg p-2">
                   <div class="stat-title text-xs">Colors</div>
                   <div class="stat-value text-lg">{{ debugStats.uniqueColors }}</div>
                </div>
                <div class="stat bg-base-200 rounded-lg p-2">
                   <div class="stat-title text-xs">Blocks</div>
                   <div class="stat-value text-lg">{{ debugStats.totalBlocks.toLocaleString() }}</div>
                </div>
                <div class="stat bg-base-200 rounded-lg p-2">
                   <div class="stat-title text-xs">Run Lengths</div>
                   <div class="stat-value text-lg">{{ debugStats.uniqueCounts }}</div>
                </div>
              </div>

              <div v-if="generatedCode && !isProcessing" class="mt-6">
                <div class="mockup-code bg-[#282c34] text-white">
                    <pre><code v-html="highlightedPreview"></code></pre>
                </div>
                <p class="text-xs text-center mt-2 opacity-60">
                   Preview mode. Total size: {{ (generatedCode.length / 1024).toFixed(1) }} KB
                </p>
              </div>
            </div>
          </section>
        `
      }

      createApp(App).mount('#app')
    </script>
  </body>
</html>