<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>DRIFT</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">
    <style>
        #deviceInOut {
            visibility: visible;
        }
    </style>
</head>
<main class="container">

    <body>
        <h1>DRIFT</h1>
        <h3>v1.6</h3>
        <button id="pairBttn">Pair Device</button>

        <section>
            <h6>RSSI Output</h6>
            <p id="out">0.0</p>
            <br>
            <h6>Strongest signal direction</h6>
            <p id="direction">0.0</p>
            <br>
        </section>

        <fieldset>
            <label>
                Target Frequency:
                <input type="number" name="targetFreq" placeholder=93.9>
            </label>
            <label>
                Device functions: <br>
                <button id="restartDevice">Restart Device</button>
                <button id="shutdownDevice">Shutdown Device</button>
            </label>
        </fieldset>
    </body>
</main>
<script>
    const deviceInOut = document.getElementById("deviceInOut")
    const rssiOut = document.getElementById("rssiOUt")

    let writeCharacteristic;
    document.getElementById("pairBttn").addEventListener("click", async () => {
        navigator.bluetooth.getAvailability().then((available) => {
            if (available) {
                let options = {
                    filters: [
                        { name: "DRIFT-P" },
                    ],
                    optionalServices: ["12345678-1234-5678-1234-5678abcdef00"]
                };
                navigator.bluetooth.requestDevice(options)
                    .then((device) => {
                        out.innerText = "Connecting to GATT Server...";
                        console.log("Device Name:", device.name);
                        return device.gatt.connect(); // Connect to the server
                    })
                    .then((server) => {
                        out.innerText = "Getting Service...";
                        return server.getPrimaryService("12345678-1234-5678-1234-5678abcdef00");
                    })
                    .then(async (service) => {
                        out.innerText = "Getting Characteristic...";

                        const notifCharacteristic = await service.getCharacteristic("12345678-1234-5678-1234-5678abcdef01");
                        await notifCharacteristic.startNotifications()
                        notifCharacteristic.addEventListener('characteristicvaluechanged', (event) => {
                            const value = event.target.value;
                            const decoder = new TextDecoder('utf-8');
                            const text = decoder.decode(value);

                            out.innerText = `Live Sensor Data: ${text}`;
                            console.log("Update received:", text);
                        });

                        writeCharacteristic = await service.getCharacteristic("12345678-1234-5678-1234-5678abcdef02");
                    })
                    .catch((error) => {
                        out.innerText = "Error (Check Console)";
                        console.error("Connection failed:", error);
                    });
            } else {
                out.innerText = "Bluetooth denied"
                return
            }
        });
    })

    async function sendDataToPI(command) {
        if (!writeCharacteristic) {
            console.error("Pi is not connected or write characteristic is not found")
        }
        try {
            const encoder = new TextEncoder("utf-8");
            const data = encoder.encode(command);
            await writeCharacteristic.writeValue(data)
            console.log(dataSent)
        } catch (err) {
            console.error(err)

        }
    }

    document.getElementById("targetFreq").addEventListener("change", async (event) => {
        sendDataToPI("FREQ:" + event.target.value)
    })
    document.getElementById("restartDevice").addEventListener("click", async () => {
        sendDataToPI("REBOOT")
    })
    document.getElementById("shutdownDevice").addEventListener("click", async () => {
        sendDataToPI("SHUTDOWN")
    })

</script>

</html>