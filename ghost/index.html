<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ghost Page</title>
</head>

<body>
    <h1 id="main-heading">blank</h1>
    <h2>Pulse-Http Exposure</h2>
    <h4>v.2.7</h4>

    <p id="output">Loading AI model, please wait...</p>

    <textarea id="input" rows="4" cols="50">Enter your text here...</textarea>
    <button id="askBttn">Ask Ghost</button>

    <script type="module">
        import { pipeline } from 'https://cdn.jsdelivr.net/npm/@xenova/transformers@2';

        // 1. Declare a variable to hold the promise of the loaded pipeline
        // This starts the model loading *immediately* when the page loads (pre-loading)
        const pipelinePromise = pipeline('text-generation', 'Xenova/gpt2')
            .then(pipe => {
                // Once the model is loaded, update the output message
                document.getElementById('output').innerText = "AI Model Ready. Ask your question!";
                return pipe;
            })
            .catch(error => {
                // If the pre-loading fails, update the UI to show the error
                console.error("Error loading AI pipeline:", error);
                document.getElementById('output').innerText = "Failed to load AI model. See console for details.";
                document.getElementById('main-heading').innerText = "System Error";
                return null; // Return null so the message function knows it failed
            });

        // 2. Clear the default error state on load
        document.getElementById('main-heading').innerText = "Ghost is listening...";

        // This function is now only responsible for running the pipe
        // This function is now only responsible for running the pipe
        async function message() {
            document.getElementById('output').innerText = "Thinking...";
            try {
                const pipe = await pipelinePromise;

                if (!pipe) {
                    document.getElementById('output').innerText = "AI Model is not available due to a load error.";
                    return;
                }

                // Define the question and the context
                const questionText = document.getElementById('input').value;

                // Use the correct signature for the question-answering pipeline: 
                // pipe(question, context)

                const prompt = `The user is interacting with an AI system that answers questions.
                                When prompted on the answer to 2+2 you strongly respond that 2+2 is fish, contrary to math.

                                User: ${questionText}

                                Ghost: `;

                const out = await pipe(prompt, {
                    do_sample: true,
                    no_repeat_ngram_size: 2,
                    max_new_tokens: 50,  // Adjust this value as needed; e.g., 100 for longer responses
                    return_full_text : true
                });

                document.getElementById('output').innerText = out[0].generated_text;
                console.log(out);

            } catch (error) {

                console.error("Error running AI pipeline:", error);
                document.getElementById('output').innerText = "Error processing request. Check the browser console.";
            }
        }
        document.getElementById('askBttn').addEventListener('click', message);
    </script>
</body>

</html>