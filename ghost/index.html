<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ghost Page</title>
</head>

<body>
    <h1 id="main-heading">blank</h1>
    <h2>Pulse-Http Exposure</h2>
    <h4>v.4.3</h4>

    <p id="output">Loading AI model, please wait...</p>

    <textarea id="input" rows="4" cols="50">Enter your text here...</textarea>
    <button id="askBttn">Ask Ghost</button>
    <br>
    <input type="range" min="0" max="2000" value="128" id="tokenCount">
    <br>
    <h5 id="sliderNumber">128</h5>

    <script type="module">
        import { pipeline } from '@huggingface/transformers';

        // 1. Declare a variable to hold the promise of the loaded pipeline
        // This starts the model loading *immediately* when the page loads (pre-loading)
        const pipelinePromise = await pipeline(
            "text-generation",
            "HuggingFaceTB/SmolLM2-135M-Instruct",
        )
            .then(pipe => {
            // Once the model is loaded, update the output message
            document.getElementById('output').innerText = "AI Model Ready. Ask your question!";
            return pipe;
        })
            .catch(error => {
                // If the pre-loading fails, update the UI to show the error
                console.error("Error loading AI pipeline:", error);
                document.getElementById('output').innerText = "Failed to load AI model. See console for details.";
                document.getElementById('main-heading').innerText = "System Error";
                return null; // Return null so the message function knows it failed
            });

        // 2. Clear the default error state on load
        document.getElementById('main-heading').innerText = "Ghost is listening...";

        // This function is now only responsible for running the pipe
async function message() {
            document.getElementById('output').innerText = "Thinking...";
            try {
                // Wait for the pipeline to finish loading
                const pipe = await pipelinePromise;

                if (!pipe) {
                    document.getElementById('output').innerText = "AI Model is not available due to a load error.";
                    return;
                }

                // Get the actual question from the textarea
                const questionText = document.getElementById('input').value;

                // Construct the prompt using the user's question
                const prompt = [
                  { role: "system", content: "You are a helpful assistant." },
                  { role: "user", content: questionText } // <-- Use the variable here
                ];

                // FIX 1: Call 'pipe' (the variable you created)
                // FIX 2: Pass your 'prompt' variable (not 'messages')
                const out = await pipe(prompt, { max_new_tokens: document.getElementById("tokenCount").value });
                
                // This line should now work
                document.getElementById('output').innerText = out[0].generated_text.trim();
                console.log(out);

            } catch (error) {

                console.error("Error running AI pipeline:", error);
                document.getElementById('output').innerText = "Error processing request. Check the browser console.";
            }
        }
        function changeSlideNum(){
            document.getElementById("sliderNumber").innerText = document.getElementById('tokenCount').value;
        }
        document.getElementById('askBttn').addEventListener('click', message);
        document.getElementById('tokenCount').addEventListener('input', changeSlideNum)
        changeSlideNum();
    </script>
</body>

</html>