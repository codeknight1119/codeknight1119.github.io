<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Pulse Wiki JSON Editor</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Monaco Editor Loader -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.41.0/min/vs/loader.js"></script>
    <style>
        /* Use Inter font and ensure the editor container fills the space */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1f2937;
        }

        #editor-container {
            height: calc(100vh - 100px);
            width: 100%;
            border-radius: 0.5rem;
            overflow: hidden;
        }

        /* Monaco editor parent must have explicit height */
        #json-editor {
            width: 100%;
            height: 100%;
        }
    </style>
</head>

<body class="p-4 md:p-8">

    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-extrabold text-white mb-4">Live Wiki Content Editor</h1>
        <div id="status"
            class="mb-4 p-3 text-sm rounded-lg shadow-md text-white bg-gray-800 transition-all duration-300">
            Initializing...
        </div>

        <button id="save-btn"
            class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg mb-4 disabled:opacity-50 transition duration-150"
            disabled>
            Save Changes (Ctrl+S / Cmd+S)
        </button>

        <div id="editor-container" class="shadow-2xl ring-2 ring-indigo-500/50">
            <div id="json-editor"></div>
        </div>
    </div>

    <script type="module">
        // --- Firebase Initialization and Globals ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import {
            getFirestore, doc, onSnapshot, setDoc, getDoc,
            setLogLevel
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Mandatory Global Variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = {
            apiKey: "AIzaSyBAW--rNK2qzIR2AxPt1eWeUzlIr6k-M_M",
            authDomain: "pulsewiki-editor.firebaseapp.com",
            projectId: "pulsewiki-editor",
            storageBucket: "pulsewiki-editor.firebasestorage.app",
            messagingSenderId: "520219616853",
            appId: "1:520219616853:web:1d76ab3dddee6a6d1696dc",
            measurementId: "G-KX6VXX3NFP"
        };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app;
        let db;
        let auth;
        let userId = null;
        let editor = null;
        let isEditorReady = false;
        let isAuthReady = false;
        let isSaving = false;

        // Firestore Path: Using the public data structure for shared wiki content
        const docRefPath = `artifacts/${appId}/public/data/wiki_content/live_doc`;

        // DOM elements
        const statusElement = document.getElementById('status');
        const saveBtn = document.getElementById('save-btn');

        function updateStatus(message, isError = false) {
            statusElement.textContent = message;
            if (isError) {
                statusElement.classList.remove('bg-gray-800');
                statusElement.classList.add('bg-red-700');
            } else {
                statusElement.classList.remove('bg-red-700');
                statusElement.classList.add('bg-gray-800');
            }
        }

        // --- Firebase Setup ---
        async function initFirebase() {
            if (!firebaseConfig) {
                updateStatus("ERROR: Firebase configuration is missing.", true);
                return;
            }

            // setLogLevel('Debug'); // Uncomment for debugging

            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    isAuthReady = true;
                    updateStatus(`Signed in as user: ${userId}. Waiting for editor...`);
                    if (isEditorReady) {
                        setupFirestoreListener();
                    }
                } else {
                    // Attempt sign in
                    try {
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        updateStatus(`Authentication failed: ${error.message}`, true);
                    }
                }
            });
        }

        // --- Firestore Realtime Listener ---
        function setupFirestoreListener() {
            if (!db || !userId || !editor) return;

            const docRef = doc(db, docRefPath);
            updateStatus("Listening for real-time document updates...");

            onSnapshot(docRef, (docSnapshot) => {
                if (docSnapshot.exists()) {
                    const data = docSnapshot.data();
                    const jsonString = data?.jsonData || '{}';

                    try {
                        // Pretty print the incoming JSON
                        const parsedJson = JSON.parse(jsonString);
                        const formattedJson = JSON.stringify(parsedJson, null, 2);

                        // Only update editor if the content is different to prevent loop
                        if (editor.getValue() !== formattedJson) {
                            editor.setValue(formattedJson);
                            // Optionally auto-format on load (Monaco action)
                            setTimeout(() => editor.getAction('editor.action.formatDocument').run(), 500);
                        }
                        updateStatus(`Document loaded and listening. Last updated by DB.`);

                    } catch (e) {
                        updateStatus(`Warning: Data from database is invalid JSON.`, true);
                        editor.setValue(jsonString); // Load raw string if invalid
                    }

                } else {
                    // Document doesn't exist, create it with initial content
                    updateStatus("Document does not exist. Initializing with empty JSON.");
                    saveDocument(JSON.stringify({
                        "title": "New Wiki Page",
                        "content": "Start editing your JSON structure here."
                    }, null, 2), false);
                }
                saveBtn.disabled = false;
            }, (error) => {
                updateStatus(`Listener Error: ${error.message}`, true);
                saveBtn.disabled = true;
            });
        }

        // --- Save Logic ---
        async function saveDocument(content = editor.getValue(), showStatus = true) {
            if (!db || !userId || isSaving) return;
            isSaving = true;
            saveBtn.disabled = true;

            try {
                if (showStatus) { updateStatus("Saving document..."); }

                // 1. Validate JSON
                let validatedJson = content;
                try {
                    // Attempt to parse and stringify to ensure it's valid JSON before saving
                    validatedJson = JSON.stringify(JSON.parse(content));
                } catch (e) {
                    updateStatus("ERROR: Invalid JSON structure. Cannot save.", true);
                    isSaving = false;
                    saveBtn.disabled = false;
                    return;
                }

                // 2. Save to Firestore
                const docRef = doc(db, docRefPath);
                const dataToSave = {
                    jsonData: validatedJson,
                    lastEditorId: userId,
                    lastEdited: new Date().toISOString()
                };
                await setDoc(docRef, dataToSave);

                if (showStatus) {
                    updateStatus("Successfully saved document!");
                }
            } catch (error) {
                updateStatus(`Save Error: ${error.message}`, true);
            } finally {
                isSaving = false;
                saveBtn.disabled = false;
                // The onSnapshot listener will update the editor with the saved content
            }
        }

        // --- Monaco Editor Setup ---
        window.onload = function () {
            // 1. Initialize Firebase first
            initFirebase();

            // 2. Load Monaco Editor via RequireJS
            require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.41.0/min/vs' } });
            require(['vs/editor/editor.main'], function () {
                editor = monaco.editor.create(document.getElementById('json-editor'), {
                    value: '{}', // Initial value before load
                    language: 'json',
                    theme: 'vs-dark',
                    automaticLayout: true,
                    minimap: { enabled: false },
                    fontFamily: 'Inter, sans-serif',
                    // Enable JSON validation features
                    'semanticValidation': true,
                    'syntacticValidation': true
                });

                isEditorReady = true;

                // 3. Attach save handler to the button
                saveBtn.addEventListener('click', () => saveDocument());

                // 4. Attach keyboard shortcut for saving (Ctrl+S / Cmd+S)
                editor.addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyCode.KeyS, () => {
                    saveDocument();
                });

                // 5. If Auth is ready, start the listener
                if (isAuthReady) {
                    setupFirestoreListener();
                }
            });
        }
    </script>
</body>

</html>